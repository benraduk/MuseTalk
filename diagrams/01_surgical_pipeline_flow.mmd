graph TD
    %% INPUT STAGE
    A[Input Video + Audio] --> B{Preprocessing Stage}
    
    %% PREPROCESSING - MUSETALK (KEEP ALL)
    B --> C[Face Detection - S3FD]
    B --> D[Audio Processing - Whisper]
    
    %% Face Detection Flow
    C --> C1["musetalk/utils/face_detection/<br/>FaceAlignment, LandmarksType"]
    C1 --> C2["musetalk/utils/preprocessing/<br/>get_landmark_and_bbox_enhanced()"]
    C2 --> C3["Frame Classification:<br/>â€¢ Face frames â†’ process<br/>â€¢ Cutaway frames â†’ passthrough"]
    
    %% Audio Processing Flow  
    D --> D1["musetalk/whisper/<br/>Whisper model (tiny)"]
    D1 --> D2["Audio feature extraction<br/>encoder_hidden_states"]
    
    %% DATA PREPARATION - MUSETALK (KEEP ALL)
    C3 --> E[Data Generation Stage]
    D2 --> E
    E --> E1["musetalk/utils/utils/<br/>datagen_enhanced()"]
    E1 --> E2["Mixed Batch Creation:<br/>â€¢ process_type_batch<br/>â€¢ latent_batch<br/>â€¢ frame_batch"]
    
    %% VAE ENCODING - MUSETALK (KEEP)
    E2 --> F["VAE Encoding<br/>(MuseTalk VAE)"]
    F --> F1["Face frames â†’ latents<br/>Cutaway frames â†’ passthrough"]
    
    %% INFERENCE STAGE - SURGICAL REPLACEMENT
    F1 --> G{Inference Stage}
    E2 --> G
    
    %% The surgical point
    G --> G1["ðŸ”„ SURGICAL REPLACEMENT:<br/>MuseTalk UNet â†’ LatentSync UNet3D"]
    G1 --> G2["OLD: unet.model(latents, timesteps, audio)<br/>NEW: unet3d_surgical(latents, audio)"]
    
    %% Post-inference processing
    G2 --> H[VAE Decoding Stage]
    H --> H1["MuseTalk VAE Decoder<br/>(KEEP - proven to work)"]
    H1 --> H2["Decoded face frames<br/>+ Original cutaway frames"]
    
    %% OUTPUT STAGE - MUSETALK (KEEP ALL)
    H2 --> I[Frame Blending Stage]
    I --> I1["musetalk/utils/blending/<br/>get_image()"]
    I1 --> I2["Frame-by-frame decision:<br/>â€¢ Face frames: blend processed<br/>â€¢ Cutaway frames: use original"]
    
    I2 --> J[Video Output]
    J --> J1["Enhanced lip-sync quality<br/>+ Reliable cutaway handling"]
    
    %% DEPENDENCY ANNOTATIONS
    classDef musetalkKeep fill:#90EE90,stroke:#006400,stroke-width:2px
    classDef surgical fill:#FFB6C1,stroke:#DC143C,stroke-width:2px
    classDef eliminated fill:#FFCCCB,stroke:#8B0000,stroke-width:2px
    classDef core fill:#87CEEB,stroke:#4682B4,stroke-width:2px
    
    class C1,C2,D1,E1,F,H1,I1 musetalkKeep
    class G1,G2 surgical
    class A,J1 core