graph LR
    %% CODE STRUCTURE - IMPLEMENTATION PLAN
    
    %% EXISTING FILES - KEEP AS IS
    subgraph "âœ… KEEP AS-IS (Working MuseTalk Components)"
        A1["musetalk/utils/face_detection/<br/>âœ… FaceAlignment class<br/>âœ… LandmarksType enum<br/>âœ… S3FD detection"]
        
        A2["musetalk/utils/preprocessing.py<br/>âœ… get_landmark_and_bbox_enhanced()<br/>âœ… coord_placeholder<br/>âœ… Enhanced preprocessing"]
        
        A3["musetalk/whisper/<br/>âœ… WhisperModel<br/>âœ… audio2feature()<br/>âœ… Audio processing"]
        
        A4["musetalk/utils/utils.py<br/>âœ… datagen_enhanced()<br/>âœ… create_enhanced_batch()<br/>âœ… Mixed batch handling"]
        
        A5["musetalk/models/vae.py<br/>âœ… VAE encoder/decoder<br/>âœ… Latent processing"]
        
        A6["musetalk/utils/blending.py<br/>âœ… get_image()<br/>âœ… Frame blending<br/>âœ… Cutaway passthrough"]
    end
    
    %% FILES TO MODIFY
    subgraph "ğŸ”„ MODIFY (Single Line Change)"
        B1["scripts/inference.py<br/>ğŸ”„ Line ~230: Replace UNet call<br/>ğŸ”„ Import hybrid_inference<br/>âœ… Keep all other logic"]
        
        B2["app.py<br/>ğŸ”„ Same UNet replacement<br/>ğŸ”„ Import hybrid_inference<br/>âœ… Keep all Gradio logic"]
    end
    
    %% NEW FILES TO CREATE  
    subgraph "ğŸ†• CREATE NEW (Surgical Integration)"
        C1["scripts/hybrid_inference.py<br/>ğŸ†• surgical_unet3d_inference()<br/>ğŸ†• load_latentsync_unet3d()<br/>ğŸ†• format_for_latentsync()<br/>ğŸ†• format_for_musetalk()"]
        
        C2["test_hybrid_integration.py<br/>ğŸ†• test_surgical_replacement()<br/>ğŸ†• test_fallback_mechanism()<br/>ğŸ†• test_quality_comparison()"]
    end
    
    %% LATENTSYNC COMPONENTS - USE SELECTIVELY
    subgraph "ğŸ”´ LATENTSYNC (Surgical Use Only)"
        D1["LatentSync/latentsync/models/unet.py<br/>ğŸ”´ UNet3DConditionModel<br/>ğŸ”´ Only this component!"]
        
        D2["LatentSync/configs/<br/>ğŸ”´ Model configuration<br/>ğŸ”´ Scheduler settings"]
    end
    
    %% ELIMINATED COMPONENTS
    subgraph "âŒ SKIP COMPLETELY (Conflict Sources)"
        E1["âŒ LatentSync preprocessing<br/>âŒ LatentSync face detection<br/>âŒ LatentSync full pipeline"]
        
        E2["âŒ MMLab components<br/>âŒ mmpose, mmcv, mmdet<br/>âŒ DWPose integration"]
        
        E3["âŒ Training components<br/>âŒ TensorFlow dependencies<br/>âŒ Tensorboard logging"]
    end
    
    %% CONNECTIONS
    A1 --> B1
    A2 --> B1
    A3 --> B1
    A4 --> B1
    A5 --> B1
    A6 --> B1
    
    B1 --> C1
    B2 --> C1
    
    C1 --> D1
    C1 --> D2
    
    C1 --> C2
    
    %% STYLING
    classDef keep fill:#90EE90,stroke:#006400,stroke-width:2px
    classDef modify fill:#FFE4B5,stroke:#FF8C00,stroke-width:2px
    classDef new fill:#87CEEB,stroke:#4682B4,stroke-width:2px
    classDef latentsync fill:#FFB6C1,stroke:#DC143C,stroke-width:2px
    classDef skip fill:#FFCCCB,stroke:#8B0000,stroke-width:2px
    
    class A1,A2,A3,A4,A5,A6 keep
    class B1,B2 modify
    class C1,C2 new
    class D1,D2 latentsync
    class E1,E2,E3 skip